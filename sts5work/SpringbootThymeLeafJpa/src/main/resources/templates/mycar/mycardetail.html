<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link
	href="https://fonts.googleapis.com/css2?family=Dongle&family=Gamja+Flower&family=Nanum+Myeongjo&family=Nanum+Pen+Script&display=swap"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
	rel="stylesheet"
	integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
	crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script
	src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
	integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
	crossorigin="anonymous"></script>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<style type="text/css">
.box {
	border: 1px solid gray;
	width: 30px;
	height: 30px;
	border-radius: 100px;
}
</style>
</head>
<body>
	<div style="margin: 100px 100px;">
		<h2>[[${dto.carname}]]</h2>
		<img alt="" th:src="@{|/carsave/${dto.carphoto}|}"
			style="width: 500px;"> <br> <br>
		<h4>
			가격: <span th:text="${#numbers.formatCurrency(dto.carprice)}"></span>
		</h4>
		<h4>
			등록일: <span
				th:text="${#calendars.format(dto.writeday,'yyyy년 MM월 dd일')}"></span>
		</h4>
		<h4>
			색상:
			<div class="box" th:style="|background-color:${dto.carcolor}|"></div>
		</h4>
		<hr>

		<!-- 댓글 목록 출력 -->
		<div class="comment-list"></div>
		<div class="d-flex">
			<input type="text" class="form-control" id="comment"
				placeholder="댓글을 입력하세요" style="width: 400px;">
			<button type="button" class="btn btn-secondary btn-sm"
				id="btncomment">저장</button>
		</div>

		<hr>
		<button type="button" class="btn btn-outline-primary"
			onclick="location='/list'">목록</button>
		<button type="button" class="btn btn-outline-primary"
			onclick="location='/addcar'">등록</button>
		<button type="button" class="btn btn-outline-primary"
			th:onclick="|location='@{/delete(num=${dto.num})}'|">삭제</button>
		<button type="button" class="btn btn-outline-primary"
			th:onclick="|location='@{/updatecar(num=${dto.num})}'|">수정</button>
	</div>

	<!-- 댓글 관련 스크립트 -->
	<script th:inline="javascript">
    $(function () {
        // 페이지 로딩 시 댓글 목록 바로 출력
        loadCommentList();

        // 댓글 저장 버튼 클릭 이벤트
        $("#btncomment").click(function () {
            let num = [[${dto.num}]];
            let comment = $("#comment").val();

            if (comment.trim() === '') {
                alert("댓글을 입력해주세요.");
                return;
            }

            $.ajax({
                type: "get",
                dataType: "html", // 성공 여부만 간단히 받음
                url: "/addcomment",
                data: {"num": num, "comment": comment},
                success: function () {
                    // 입력창 비우고 댓글 목록 다시 불러오기
                    $("#comment").val('');
                    loadCommentList();
                }
            });
        });
    });

    // 댓글 목록을 불러오는 함수
    function loadCommentList() {
        let num = [[${dto.num}]];

        $.ajax({
            type: "get",
            dataType: "json",
            url: "commentlist",
            data: {"num": num},
            success: function (res) {
                let s = `댓글 &nbsp;&nbsp;${res.length}개`;
                $.each(res, function (idx, item) {
                    s += `
                        <div style="margin-left:20px;">
                           ${item.comment}
                           <span style="color:gray; font-size: 0.85em; margin-left: 10px;">
                               ${item.writeday}
                           </span>
                        </div>`;
                });
                $(".comment-list").html(s);
            }
        });
    }
</script>

</body>
</html>