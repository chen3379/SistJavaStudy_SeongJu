<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subway Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container text-center mt-5">
        <div id="initialView">
            <h1>내 지하철 찾기</h1>
            <p>지하철 탑승 후 아래 버튼을 눌러주세요.</p>
            <button id="findBtn" class="btn btn-primary btn-lg">내 열차 찾기</button>
        </div>

        <div id="resultView" class="mt-4">
            <!-- Results will be injected here by JavaScript -->
        </div>
    </div>

    <script>
        const findBtn = document.getElementById('findBtn');
        const initialView = document.getElementById('initialView');
        const resultView = document.getElementById('resultView');

        findBtn.addEventListener('click', () => {
            resultView.innerHTML = '<p>GPS 위치를 가져오는 중...</p>';

            if (!navigator.geolocation) {
                resultView.innerHTML = '<p>이 브라우저에서는 위치 정보가 지원되지 않습니다.</p>';
                return;
            }

            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                resultView.innerHTML = `<p>가장 가까운 역의 열차 정보를 찾는 중...</p>`;

                // Send location to the new backend endpoint
                fetch('/api/find-departures-by-location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ latitude, longitude }),
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    displayDepartures(data);
                })
                .catch(error => {
                    resultView.innerHTML = '<p>열차 정보를 가져오는 데 실패했습니다.</p>';
                    console.error('Error:', error);
                });

            }, () => {
                resultView.innerHTML = '<p>위치 정보를 가져오는 데 실패했습니다. 권한을 확인해주세요.</p>';
            });
        });

        function displayDepartures(departures) {
            if (!departures || departures.length === 0) {
                resultView.innerHTML = `<p>실시간 열차 정보가 없습니다.</p>`;
                return;
            }
            
            let html = `<h3>실시간 열차 현황</h3>
                        <p>탑승하신 열차를 선택해주세요.</p>
                        <div class="list-group">`;

            departures.forEach(train => {
                html += `<a href="#" class="list-group-item list-group-item-action" 
                           onclick="selectTrain('${train.trainNo}')">
                           <div class="d-flex w-100 justify-content-between">
                               <h5 class="mb-1">${train.subwayNm} ${train.statnTnm} 방면</h5>
                               <small>${train.recptnDt}</small>
                           </div>
                           <p class="mb-1">열차 번호: ${train.trainNo} / 상태: ${train.trainSttus}</p>
                        </a>`;
            });

            html += '</div>';
            resultView.innerHTML = html;
        }
        
        function selectTrain(trainNo) {
            initialView.classList.add('d-none'); // Hide initial button
            resultView.innerHTML = `<h2>선택하신 열차는 ${trainNo} 입니다.</h2>
                                    <p>해당 열차 정보를 계속 추적합니다.</p>
                                    <button class="btn btn-secondary mt-3" onclick="window.location.reload()">다시 검색하기</button>`;
        }

    </script>
</body>
</html>
